<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Genealogos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <script>
        // Set the data-bs-theme tag of the html object to light/dark depending on the browser settings
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-bs-theme', prefersDarkMode ? 'dark' : 'light');
    </script>
    <div class="container-lg">
        <div class="row">
            <div class="col">
                <h1 class="text-center mt-5">Genealogos</h1>
                <p> Genealogos is a tool to generate a Software Bill of Materials (SBOM) for a given flake ref and
                    attribute path. It uses the nixtract to analyze the flake and generate the dependency tree. The SBOM
                    is generated in JSON format and can be copied to the clipboard or saved as a file.</p>
                <div class="mb-3">
                    <label for="flake-ref">Flake Ref</label>
                    <input type="text" class="form-control" id="flake-ref" name="flake-ref" placeholder="nixpkgs">
                </div>
                <div class="mb-3">
                    <label for="attribute-path">Attribute Path</label>
                    <input type="text" class="form-control" id="attribute-path" name="attribute-path"
                        placeholder="hello">
                </div>
                <div class="mb-3">
                    <label for="sbom-version">SBOM Version</label>
                    <select class="form-select" id="sbom-version" name="sbom-version">
                        <option value="1_4">CycloneDX 1.4</option>
                        <option value="1_5" selected>CycloneDX 1.5</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-primary mb-3" onclick="generateSBOM()">Generate SBOM</button>
                    <div>
                        <button class="btn btn-secondary" onclick="copySBOM()" disabled>Copy SBOM to
                            Clipboard</button>
                        <button class="btn btn-secondary" onclick="saveSBOM()" disabled>Save SBOM</button>
                    </div>
                </div>
                <pre id="sbom-container">No SBOM yet</pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        function generateSBOM() {
            // Get the flake ref and attribute path from the input fields
            const flakeRef = document.getElementById("flake-ref").value;
            const attributePath = document.getElementById("attribute-path").value;

            // Set the content of the sbom-container to a loading spinner
            document.getElementById("sbom-container").innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            // Disable the generate SBOM button
            document.querySelector(".btn-primary").disabled = true;

            // Make a request to 127.0.0.1:8080/api/analyze with flake_ref and attribute_path as get parameters
            const response = fetch(`http://127.0.0.1:8000/api/analyze?flake_ref=${flakeRef}&attribute_path=${attributePath}`)
                .then(response => response.json())
                .then(data => {
                    // Convert the response to a JSON string
                    const sbom = JSON.stringify(data, null, 2);

                    console.log(sbom);

                    // Display the SBOM in the code container
                    document.getElementById("sbom-container").textContent = sbom;

                    // Enable the generate SBOM button
                    document.querySelector(".btn-primary").disabled = false;
                    // Enable the copy and save SBOM buttons
                    document.querySelector(".btn-secondary:first-of-type").disabled = false;
                    document.querySelector(".btn-secondary:last-of-type").disabled = false;
                });

        }

        function copySBOM() {
            // Get the SBOM text
            const sbomText = document.getElementById("sbom-container").textContent;

            // Create a textarea element
            const textarea = document.createElement("textarea");
            textarea.value = sbomText;

            // Append the textarea to the body
            document.body.appendChild(textarea);

            // Select the text in the textarea
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            // Copy the text to the clipboard
            document.execCommand("copy");

            // Remove the textarea
            document.body.removeChild(textarea);

            // Show a success message
            alert("SBOM copied to clipboard!");
        }

        function saveSBOM() {
            // Get the SBOM text
            const sbomText = document.getElementById("sbom-container").textContent;

            // Create a blob with the SBOM text
            const blob = new Blob([sbomText], { type: "text/plain;charset=utf-8" });

            // Create a temporary anchor element
            const anchor = document.createElement("a");
            anchor.href = URL.createObjectURL(blob);
            anchor.download = `sbom_${flakeRef}_${attributePath}.sbom.json`;

            // Programmatically click the anchor element to trigger the download
            anchor.click();

            // Clean up the temporary anchor element
            URL.revokeObjectURL(anchor.href);
        }

    </script>
</body>

</html>