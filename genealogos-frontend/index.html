<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Genealogos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">Genealogos</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openSettings()">Settings</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://tweag.io">
                            Tweag
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5" />
                                <path fill-rule="evenodd"
                                    d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z" />
                            </svg> </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/tweag/Genealogos">
                            GitHub
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5" />
                                <path fill-rule="evenodd"
                                    d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z" />
                            </svg> </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-lg">
        <div class="row">
            <div class="col">
                <h1 class="text-center mt-5">Genealogos</h1>
                <p> Genealogos is a tool to generate a Software Bill of Materials (SBOM) for a given flake ref and
                    attribute path. It uses the nixtract to analyze the flake and generate the dependency tree. The SBOM
                    is generated in JSON format and can be copied to the clipboard or saved as a file.</p>
                <div class="mb-3">
                    <label for="flake-ref">Flake Ref</label>
                    <input type="text" class="form-control" id="flake-ref" name="flake-ref" placeholder="nixpkgs">
                </div>
                <div class="mb-3">
                    <label for="attribute-path">Attribute Path</label>
                    <input type="text" class="form-control" id="attribute-path" name="attribute-path"
                        placeholder="hello">
                </div>
                <div class="mb-3">
                    <label for="sbom-version">SBOM Version</label>
                    <select class="form-select" id="sbom-version" name="sbom-version">
                        <option value="1_4">CycloneDX 1.4</option>
                        <option value="1_5" selected>CycloneDX 1.5</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-primary mb-3" onclick="generateSBOM()">Generate SBOM</button>
                    <div>
                        <button class="btn btn-secondary" onclick="copySBOM()" disabled>Copy SBOM to
                            Clipboard</button>
                        <button class="btn btn-secondary" onclick="saveSBOM()" disabled>Save SBOM</button>
                    </div>
                </div>
                <pre id="sbom-container">No SBOM yet</pre>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="api-address">Genealogos API Address</label>
                        <input type="text" class="form-control" id="api-address" name="api-address"
                            placeholder="http://localhost:8000/api">
                        <small class="form-text text-muted">Enter the address of the Genealogos API. This is the
                            endpoint where the flake ref, attribute path, and any other settings will be send for
                            processing. For example:
                            <ul>
                                <li>https://genealogos.tweag.io/api</li>
                                <li>https://127.0.0.1:8000/api</li>
                            </ul>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        // Global variables for flake ref and attribute path
        let latestFlakeRef = "";
        let latestAttributePath = "";
        let apiAddress = "http://localhost:8000/api"; // Default API address

        // Always set the copy and save button to disabled on page load, this fixes a firefox bug
        document.querySelector(".btn-secondary:first-of-type").disabled = true;
        document.querySelector(".btn-secondary:last-of-type").disabled = true;

        function generateSBOM() {
            // Get the flake ref and attribute path from the input fields
            const flakeRef = document.getElementById("flake-ref").value;
            const attributePath = document.getElementById("attribute-path").value;
            const cycloneDxVer = document.getElementById("sbom-version").value;

            document.getElementById("sbom-container").classList.remove("alert", "alert-warning"); // Remove error class if present

            // Set the content of the sbom-container to a loading spinner
            document.getElementById("sbom-container").innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            // Disable the generate SBOM button
            document.querySelector(".btn-primary").disabled = true;

            // Make a request to the API with flake_ref and attribute_path as get parameters
            const response = fetch(`${apiAddress}/analyze?flake_ref=${flakeRef}&attribute_path=${attributePath}&cyclonedx_version=v${cycloneDxVer}`)
                .then(response => response.json())
                .then(data => {
                    if (data.sbom) {
                        // Convert the response to a JSON string
                        const sbom = JSON.stringify(data.sbom, null, 2);

                        // Display the SBOM in the code container
                        document.getElementById("sbom-container").textContent = sbom;

                        // Enable the generate SBOM button
                        document.querySelector(".btn-primary").disabled = false;
                        // Enable the copy and save SBOM buttons
                        document.querySelector(".btn-secondary:first-of-type").disabled = false;
                        document.querySelector(".btn-secondary:last-of-type").disabled = false;

                        // Set the global variables
                        latestFlakeRef = flakeRef;
                        latestAttributePath = attributePath;
                    } else if (data.message) {
                        // Display the error message in the code container
                        document.getElementById("sbom-container").textContent = "Error: " + data.message;
                        document.getElementById("sbom-container").classList.add("alert", "alert-warning"); // Add error classes

                        // Enable the generate SBOM button
                        document.querySelector(".btn-primary").disabled = false;
                        // Disable the copy and save SBOM buttons
                        document.querySelector(".btn-secondary:first-of-type").disabled = true;
                        document.querySelector(".btn-secondary:last-of-type").disabled = true;
                    }
                })
                .catch(error => {
                    // Display the error message in the code container
                    document.getElementById("sbom-container").textContent = "Error: " + error;
                    document.getElementById("sbom-container").classList.add("alert", "alert-warning"); // Add error classes

                    // Enable the generate SBOM button
                    document.querySelector(".btn-primary").disabled = false;
                    // Disable the copy and save SBOM buttons
                    document.querySelector(".btn-secondary:first-of-type").disabled = true;
                    document.querySelector(".btn-secondary:last-of-type").disabled = true;
                });
        }

        function copySBOM() {
            // Get the SBOM text
            const sbomText = document.getElementById("sbom-container").textContent;

            // Create a textarea element
            const textarea = document.createElement("textarea");
            textarea.value = sbomText;

            // Append the textarea to the body
            document.body.appendChild(textarea);

            // Select the text in the textarea
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            // Copy the text to the clipboard
            document.execCommand("copy");

            // Remove the textarea
            document.body.removeChild(textarea);

            // Show a success message
            alert("SBOM copied to clipboard!");
        }

        function saveSBOM() {
            // Get the SBOM text
            const sbomText = document.getElementById("sbom-container").textContent;

            // Create a blob with the SBOM text
            const blob = new Blob([sbomText], { type: "text/plain;charset=utf-8" });

            // Create a temporary anchor element
            const anchor = document.createElement("a");
            anchor.href = URL.createObjectURL(blob);
            anchor.download = `${latestFlakeRef}_${latestAttributePath}.sbom.json`;

            // Programmatically click the anchor element to trigger the download
            anchor.click();

            // Clean up the temporary anchor element
            URL.revokeObjectURL(anchor.href);
        }

        function openSettings() {
            // Get the API address input field
            const apiAddressInput = document.getElementById("api-address");

            // Set the current API address in the input field
            apiAddressInput.value = apiAddress;

            // Open the settings modal
            const settingsModal = new bootstrap.Modal(document.getElementById("settings-modal"));
            settingsModal.show();
        }

        function saveSettings() {
            // Get the API address input field
            const apiAddressInput = document.getElementById("api-address");

            // Update the global API address variable
            apiAddress = apiAddressInput.value;

            // Close the settings modal
            const settingsModal = bootstrap.Modal.getInstance(document.getElementById("settings-modal"));
            settingsModal.hide();
        }

    </script>
</body>

</html>